name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  ZIG_VERSION: '0.14.0'

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            .zig-cache
            zig-cache
          key: ${{ runner.os }}-zig-${{ env.ZIG_VERSION }}-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            ${{ runner.os }}-zig-${{ env.ZIG_VERSION }}-

      - name: Build release binary
        run: zig build -Doptimize=ReleaseSafe

      - name: Test basic shell startup
        run: |
          echo "Testing shell startup..."
          ./zig-out/bin/den -c "echo 'Hello from Den'"

      - name: Test builtin commands
        run: |
          echo "Testing builtin commands..."
          ./zig-out/bin/den -c "pwd"
          ./zig-out/bin/den -c "echo test"
          ./zig-out/bin/den -c "true"
          ./zig-out/bin/den -c "false" || true

      - name: Test environment variables
        run: |
          echo "Testing environment variables..."
          ./zig-out/bin/den -c "export TEST_VAR=hello && echo \$TEST_VAR"

      - name: Test command chaining
        run: |
          echo "Testing command chaining..."
          ./zig-out/bin/den -c "echo 'first' && echo 'second'"
          ./zig-out/bin/den -c "false || echo 'fallback'"

      - name: Test pipes (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "Testing pipes..."
          ./zig-out/bin/den -c "echo 'hello world' | cat"

      - name: Test redirections
        run: |
          echo "Testing redirections..."
          ./zig-out/bin/den -c "echo 'test content' > /tmp/den_test.txt"
          ./zig-out/bin/den -c "cat /tmp/den_test.txt"
          rm -f /tmp/den_test.txt

      - name: Test arithmetic
        run: |
          echo "Testing arithmetic..."
          ./zig-out/bin/den -c "calc 2 + 2"
          ./zig-out/bin/den -c "calc 10 * 5"

      - name: Test productivity builtins
        run: |
          echo "Testing productivity builtins..."
          ./zig-out/bin/den -c "date"
          ./zig-out/bin/den -c "seq 1 5"
          ./zig-out/bin/den -c "uuid" || true

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs-${{ matrix.os }}
          path: |
            zig-out/
            .zig-cache/

  e2e-shell-session:
    name: End-to-End Shell Session
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build
        run: zig build -Doptimize=ReleaseSafe

      - name: Run E2E tests
        run: |
          set -e
          echo "=== E2E Shell Session Test ==="

          # Test 1: Basic commands
          echo "Test 1: Basic commands"
          ./zig-out/bin/den -c "pwd"
          ./zig-out/bin/den -c "echo 'Hello World'"

          # Test 2: Directory navigation
          echo "Test 2: Directory navigation"
          mkdir -p test_dir
          ./zig-out/bin/den -c "cd test_dir && pwd"
          rm -rf test_dir

          # Test 3: File manipulation
          echo "Test 3: File manipulation"
          ./zig-out/bin/den -c "echo 'test' > temp.txt"
          ./zig-out/bin/den -c "cat temp.txt"
          rm -f temp.txt

          # Test 4: Builtins
          echo "Test 4: Builtins"
          ./zig-out/bin/den -c "calc 10 + 20"
          ./zig-out/bin/den -c "seq 1 3"

          # Test 5: Complex commands
          echo "Test 5: Complex commands"
          ./zig-out/bin/den -c "echo 'test' && echo 'success'"

          echo "=== All E2E tests passed! ==="

  performance-benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build release
        run: zig build -Doptimize=ReleaseFast

      - name: Install hyperfine
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Benchmark startup time
        run: |
          echo "=== Startup Time Benchmark ==="
          hyperfine --warmup 3 --min-runs 10 \
            './zig-out/bin/den -c "true"' \
            --export-json startup-benchmark.json

      - name: Benchmark echo command
        run: |
          echo "=== Echo Command Benchmark ==="
          hyperfine --warmup 3 --min-runs 10 \
            './zig-out/bin/den -c "echo hello"' \
            --export-json echo-benchmark.json

      - name: Benchmark command chaining
        run: |
          echo "=== Command Chaining Benchmark ==="
          hyperfine --warmup 3 --min-runs 10 \
            './zig-out/bin/den -c "true && true && true"' \
            --export-json chain-benchmark.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            *-benchmark.json

      - name: Show benchmark summary
        run: |
          echo "=== Benchmark Summary ==="
          cat startup-benchmark.json | jq '.results[0] | {command, mean, stddev, min, max}'
          cat echo-benchmark.json | jq '.results[0] | {command, mean, stddev, min, max}'
          cat chain-benchmark.json | jq '.results[0] | {command, mean, stddev, min, max}'
